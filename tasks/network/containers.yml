---

- name: create network for all services
  docker_network:
    name: traefik

# traefik 
- name: traefik reverse proxy
  docker_container:
    name: traefik
    image: traefik:v2.11
    ports:
      - "80:80"
      - "81:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    command: ["--api.insecure=true", "--providers.docker"]
    networks:
      - name: "traefik"
    restart_policy: unless-stopped

- name: create promtail volume
  docker_volume:
    name: promtail_data

- name: promtail container
  docker_container:
    name: promtail
    image: grafana/promtail:3.0.0 
    volumes:
      - "promtail_data:/etc/promtail"
      - "/var/log:/var/log"
    networks:
      - name: "traefik"
    restart_policy: unless-stopped

- name: node_exporter container
  docker_container:
    name: node_exporter
    image: prom/node-exporter:v1.8.0
    command: ["--path.rootfs=/host"]
    ports:
      - "9100:9100"
    volumes:
      - "/:/host:ro,rslave"
    networks:
      - name: "traefik"
    restart_policy: unless-stopped

# Bind DNS
- name: bind docker container
  docker_container:
    name: bind-dns
    image: ubuntu/bind9@sha256:05f8b440e2989ac6881747808473e8103120dfd6d86f9dace2323124594656db
    volumes:
      - "/home/anthony/docker-volumes/bind-dns/config:/etc/bind"
      - "/home/anthony/docker-volumes/bind-dns/cache:/var/cache/bind"
      - "/home/anthony/docker-volumes/bind-dns/records:/var/lib/bind"
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    env:
      BIND9_USER: 'root'
      TZ: "{{ timezone }}"
    restart_policy: unless-stopped

# duckdns
- name: duckdns
  docker_container:
    name: duckdns
    image: linuxserver/duckdns@sha256:0a836abf773b45438f63c2b4aba17c4c0c546a4bcc575f91113e51cda5dec883
    volumes:
      - "/home/anthony/docker-volumes/duckdns/config:/config"
    env:
      PUID: "1000"
      PGID: "1000"
      TZ: "{{ timezone }}"
      SUBDOMAINS: "{{ ddns_subdomains }}"
      TOKEN: "{{ ddns_token }}"
    restart_policy: unless-stopped

# wireguard
- name: wireguard
  docker_container:
    name: wireguard
    image: linuxserver/wireguard:1.0.20210914
    ports:
      - "51820:51820/udp"
    volumes:
      - "/home/anthony/docker-volumes/wireguard/config:/config"
      - "/lib/modules:/lib/modules"
    env:
      PUID: "1000"
      PGID: "1000"
      SERVERURL: "mole-homelab.duckdns.org"
      PEERS: "desktop,laptop,phone,tablet"
      INTERNAL_SUBNET: 10.13.13.0/24
      TZ: "{{ timezone }}"
    capabilities:
      - net_admin
      - sys_module
    sysctls:
      net.ipv4.conf.all.src_valid_mark: 1
    restart_policy: unless-stopped

# mosquitto
- name: mosquitto
  docker_container:
    name: mosquitto
    image: eclipse-mosquitto:1.6.12
    ports:
      - "1883:1883"
    volumes:
      - "/home/anthony/docker-volumes/mosquitto/data:/data"
      - "/home/anthony/docker-volumes/mosquitto/config:/config"
      - "/home/anthony/docker-volumes/mosquitto/logs:/logs"
    env:
      PUID: "1000"
      PGID: "1000"
    networks:
      - name: "traefik"
    restart_policy: unless-stopped

# home assistant
- name: home-assistant
  docker_container:
    name: home-assistant
    image: ghcr.io/home-assistant/home-assistant@sha256:321386d6592cf5a67042f9fa44c3cb5f1af08ad0efb4e7c4ba3ffe852bae4715
    network_mode: 'host'
    volumes:
      - "/home/anthony/docker-volumes/hass/config:/config"
    env:
      TZ: "{{ timezone }}"
    devices:
      - "/dev/serial/by-id/usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_20230525115147-if00:/dev/ttyACM0"
    restart_policy: unless-stopped

# one dev
- name: onedev
  docker_container:
    name: onedev
    image: 1dev/server:10.5.3
    ports:
      - "6610:6610"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "{{ docker_path }}/onedev:/opt/onedev"
    networks:
      - name: "traefik"
    labels:
      traefik.http.routers.onedev.rule: "Host(`onedev.homelab.lan`)"
    restart_policy: unless-stopped

- name: omada-controller
  docker_container:
    name: omada
    image: mbently/omada_controller:5.13
    ports:
      - "8088:8088"
      - "8043:8043"
      - "27001:27001/udp"
      - "29810:29810/udp"
      - "29811-29816:29811-29816"
    volumes:
      - "{{ docker_path }}/omada/logs:/opt/tplink/EAPController/data"
      - "{{ docker_path }}/omada/data:/opt/tplink/EAPController/logs"
    env:
      TZ: "{{ timezone }}"
    restart_policy: unless-stopped

# renovate
#- name: renovate
# docker_container:
#   name: renovate-bot
#   image: renovate/renovate:37-full
#   networks:
#     - name: "traefik"
#   restart_policy: unless-stopped


